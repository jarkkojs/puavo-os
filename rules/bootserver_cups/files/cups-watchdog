#!/bin/sh

set -eu

echo "$(date --rfc-3339=seconds) started" >&2

while true; do
  sleep 30

  lpstat -a > /dev/null 2>&1 &
  lpstatpid=$!
  sleep 4

  kill -0 "$lpstatpid" 2>/dev/null || continue

  kill "$lpstatpid" || true
  service cups restart || true

  echo "$(date --rfc-3339=seconds) cups restarted" >&2
done
