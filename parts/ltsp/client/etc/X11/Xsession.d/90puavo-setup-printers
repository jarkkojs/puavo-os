# -*- sh -*-
# Xsession.d script to set the printers according to Puavo settings
#
# This file is sourced by Xsession(5), not executed.

puavo_pslog() {
  logger -t 90puavo-setup-printers "$@"
}

limit_printer_visibility() {
  local managed_printer_list managed_printer puavo_printers_list OLDIFS \
        use_puavo_permissions

  if [ "$(puavo-conf puavo.printing.use_puavo_permissions)" = 'true' ]; then
    puavo_pslog -p user.notice \
      'puavo.printing.use_puavo_permission is true, limiting printer visibility'
    use_puavo_permissions=true
  else
    puavo_pslog -p user.err \
      'puavo.printing.use_puavo_permission is not true, all printers shown'
    use_puavo_permissions=false
  fi

  if ! managed_printer_list=$(
    jq -r '.[] | .name' /var/lib/puavo-desktop/shared/dnssd_printers.json); then
      puavo_pslog -p user.err 'could not find a list of managed printers'
      return 1
  fi
  if ! puavo_printers_list=$(jq -r '.printer_queues[] | .name' \
                               "$PUAVO_SESSION_PATH"); then
    puavo_pslog -p user.err 'could not find a list of printers in puavo'
    return 1
  fi

  OLDIFS="$IFS"
  IFS='
'
  for managed_printer in $managed_printer_list; do
    if ! $use_puavo_permissions \
      || { printf "%s\n" "$puavo_printers_list" | grep -qx "$managed_printer"; }; then
        # this printer is listed as visible in Puavo
        if $use_puavo_permissions; then
          puavo_pslog -p user.info \
                      "making printer ${managed_printer} visible to user ${USER}"
        fi
        if ! lpadmin -p "$managed_printer" -u "allow:${USER}"; then
          puavo_pslog -p user.err "error when making $managed_printer visible"
        fi
    else
      # this printer should not be shown
      puavo_pslog -p user.info \
                  "hiding printer ${managed_printer} from user ${USER}"
      if ! lpadmin -p "$managed_printer" -u "deny:${USER}"; then
        puavo_pslog -p user.err "error when hiding $managed_printer"
      fi
    fi
  done
  IFS="$OLDIFS"
}

set_default_printer() {
  local default_printer_name

  default_printer_name=$(jq -r '.device.default_printer_name' \
                           "$PUAVO_SESSION_PATH")
  if [ "$default_printer_name" != 'null' ]; then
    lpadmin -d "$default_printer_name"
  fi
}

# Run puavo-dnssd-printer-client on fatclients so we get to see printers.
# On laptops we can not presume a network at this stage, therefore we run
# puavo-dnssd-printer-client from
# /etc/NetworkManager/dispatcher.d/dnssd-printers when connecting to a network.
if [ -e /run/puavo/nbd-server ]; then
  if ! puavo-dnssd-printer-client; then
    puavo_pslog -p user.err 'error running puavo-dnssd-printer-client'
  fi
fi

if [ ! -e "$PUAVO_SESSION_PATH" ]; then
  puavo_pslog -p user.err \
              'no puavo session data, can not limit printer visibility'
  return 1
fi

if ! limit_printer_visibility; then
  puavo_pslog -p user.notice 'some error in limiting printer visibility'
fi

set_default_printer
