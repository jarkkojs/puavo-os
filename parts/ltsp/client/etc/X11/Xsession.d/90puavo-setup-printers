# -*- sh -*-
# Xsession.d script to set the printers according to Puavo settings
#
# This file is sourced by Xsession(5), not executed.

remove_remote_printers() {
  LANG=C lpstat -v | while read line; do
    name=$(printf %s "$line" | sed -r -n 's|^device for (.*): ipp://.*$|\1|p')
    [ -n "$name" ] || continue
    lpadmin -x "$name"
  done
}

add_remote_printers() {
  local puavo_domain=$(cat /etc/puavo/domain)
  readonly puavo_domain

  [ -e "$PUAVO_SESSION_PATH" ] || return 1

  jq -r -c '.printer_queues[]' "$PUAVO_SESSION_PATH" | while read printer; do
    name=$(printf %s "$printer" | jq -r -c .name)
    location=$(printf %s "$printer" | jq -r -c .location)
    description=$(printf %s "$printer" | jq -r -c .description)
    remote_uri="ipp://cups.${puavo_domain}:631/printers/${name}"

    lpadmin -p "$name" -v "$remote_uri" -L "$location" -D "$description" -E -m everywhere
  done
}

set_default_printer() {
  local default_printer_name

  [ -e "$PUAVO_SESSION_PATH" ] || return 1

  default_printer_name=$(jq -r .device.default_printer_name "$PUAVO_SESSION_PATH")
  [ "$default_printer_name" != null ] && lpadmin -d "$default_printer_name"
}

# Run these only on fatclients, laptops have their own printer management
# mechanism (/usr/sbin/puavo-dnssd-printer-client).  These presume a working
# network and we do not want laptops logins to have issues because of these.
if [ -e /run/puavo/nbd-server ]; then
  remove_remote_printers
  add_remote_printers
  set_default_printer
fi

if [ "$(puavo-conf puavo.printing.use_puavo_permissions)" = 'true' ]; then
  # XXX setting PRINTER_LIST does not work anymore, we need something else
  # XXX to restrict printer visibility
  :
fi
